<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN"
    "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
      xmlns:dc="http://purl.org/dc/elements/1.1/"
      xmlns:foaf="http://xmlns.com/foaf/0.1/">
  
  <head>
    
    
      
        <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
      
      
      <title>
        frozen » 
        Tutorial: making NoSQL storage from any data
      </title>
      
      
        <!-- YUI CSS reset, fonts, base -->
        <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?3.0.0/build/cssreset/reset-min.css&amp;3.0.0/build/cssfonts/fonts-min.css&amp;3.0.0/build/cssbase/base-min.css" media="screen, projection" />
        
        <link rel="stylesheet" type="text/css" href="media/css/style.css" media="screen, projection" />
        <link rel="stylesheet" type="text/css" href="media/css/pygments.css" media="screen, projection" />
      
      
      
      
      
        
          <!-- Google Analytics -->
          <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-7806052-2']);
            _gaq.push(['_trackPageview']);
            (function() {
              var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
              ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
            })();
          </script>
        
      
    
  </head>
  
  <body >
    
      
      
        
          
  
    <ol id="breadcrumbs">
      
        <li class="crumb-0 not-last">
          
            <a href="./">index</a>
          
        </li>
      
        <li class="crumb-1 last">
          
            tutorial_complexdata
          
        </li>
      
    </ol> <!-- ol#breadcrumbs -->
  

        
      
      
      <div id="content">
        
        
        
        <h1>Tutorial: making NoSQL storage from any data</h1>
<p>Frozen can create NoSQL storage on top of any data it can parse. By using special formats and chains of data we can construct
any complex data with indexing and all fancy stuff.</p>
<h2>Simple key-value</h2>
<p>Let's start from something very simple, like key-value store with values embedded right into configuration.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">local</span> <span class="n">db</span> <span class="p">=</span> <span class="p">{</span>                                       <span class="o">//</span> <span class="n">define</span> <span class="n">db</span> 
    <span class="n">key1</span> <span class="p">=</span> &quot;<span class="n">value1</span>&quot;<span class="p">,</span> <span class="n">key2</span> <span class="p">=</span> &quot;<span class="n">value2</span>&quot;
<span class="p">}</span>

<span class="n">sub</span> <span class="p">{</span>
    $<span class="n">value1</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">,</span> $<span class="n">value2</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">;</span>  <span class="o">//</span> <span class="n">temporary</span> <span class="n">variables</span>

    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">hashkey_t</span><span class="p">:</span>&quot;<span class="n">key1</span>&quot;<span class="p">,</span> $<span class="n">value1</span><span class="p">);</span>      <span class="o">//</span> <span class="n">get</span> <span class="n">values</span>
    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">hashkey_t</span><span class="p">:</span>&quot;<span class="n">key2</span>&quot;<span class="p">,</span> $<span class="n">value2</span><span class="p">);</span>

    $<span class="n">value1</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>                   <span class="o">//</span> <span class="n">print</span> <span class="n">them</span>
    $<span class="n">value2</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>As you can see here, we define "db" as hash with key1 and key2 in it. Next, we lookup this values and print them. Nothing special here, because
any high-level language can do that. </p>
<h2>Key-value from string</h2>
<p>Next one to try is to make data from some external data. First of all, we will try simple string.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">local</span> <span class="n">db</span> <span class="p">=</span> 
    <span class="n">format</span> <span class="o">~</span> <span class="n">record_t</span> <span class="p">:</span> &quot;<span class="o">\</span><span class="n">n</span>&quot;   <span class="o">&gt;</span>               <span class="o">//</span> <span class="n">use</span> <span class="n">record_t</span> <span class="n">as</span> <span class="n">format</span> <span class="k">for</span> <span class="n">data</span>
    &quot;<span class="n">value1</span><span class="o">\</span><span class="n">nvalue2</span><span class="o">\</span><span class="n">n</span>&quot;

<span class="n">sub</span> <span class="p">{</span>
    $<span class="n">value1</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">,</span> $<span class="n">value2</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">;</span>

    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>0<span class="p">,</span> $<span class="n">value1</span><span class="p">);</span>
    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>7<span class="p">,</span> $<span class="n">value2</span><span class="p">);</span>

    $<span class="n">value1</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
    $<span class="n">value2</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Here we have string, with "record_t" data on top of it and this defined as "format". That means that any data that pass thought format
converted to template defined. In this case to "record_t". Record_t represent one line in this case, because it looks for "\n".
Notice that we use numerics to query our "database", instead of hashkey_t as in previous example. Also notice that this numeric represent offset 
in target string, not line number as could one think about it at first sight.</p>
<p>To remove this numeric offsets and query data by line number we need some help. Lets use "key ~" to store data offsets.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">local</span> <span class="n">db</span> <span class="p">=</span> 
    <span class="n">key</span>    <span class="o">~</span> <span class="n">list_t</span> <span class="p">:</span> <span class="p">{</span>               <span class="o">//</span> <span class="n">use</span> <span class="n">list_t</span> <span class="n">as</span> <span class="n">key</span> <span class="n">mapper</span>
        0<span class="p">,</span> 7
    <span class="p">}</span>                          <span class="o">&gt;</span>
    <span class="n">format</span> <span class="o">~</span> <span class="n">record_t</span> <span class="p">:</span> &quot;<span class="o">\</span><span class="n">n</span>&quot;   <span class="o">&gt;</span>
    &quot;<span class="n">value1</span><span class="o">\</span><span class="n">nvalue2</span><span class="o">\</span><span class="n">n</span>&quot;

<span class="n">sub</span> <span class="p">{</span>
    $<span class="n">value1</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">,</span> $<span class="n">value2</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">;</span>

    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>0<span class="p">,</span> $<span class="n">value1</span><span class="p">);</span>
    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>1<span class="p">,</span> $<span class="n">value2</span><span class="p">);</span>

    $<span class="n">value1</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
    $<span class="n">value2</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>As you can see we moved our offsets inside database definition, and now our client know only what it have two elements with id=0 and id=1.
But what if we have a lot of such lines and don't want to write offsets manually. We have to enumerate all items and add them to our list
with offsets.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">local</span> <span class="n">db</span> <span class="p">=</span> 
    <span class="n">key</span>    <span class="o">~</span> <span class="n">list_t</span> <span class="p">:</span> <span class="p">{</span> <span class="p">}</span>      <span class="o">&gt;</span>         <span class="o">//</span> <span class="n">empty</span> <span class="n">list</span> <span class="n">here</span><span class="p">,</span> <span class="n">we</span> <span class="n">will</span> <span class="n">fill</span> <span class="n">it</span> <span class="n">later</span>
    <span class="n">format</span> <span class="o">~</span> <span class="n">record_t</span> <span class="p">:</span> &quot;<span class="o">\</span><span class="n">n</span>&quot;   <span class="o">&gt;</span>
    &quot;<span class="n">value1</span><span class="o">\</span><span class="n">nvalue2</span><span class="o">\</span><span class="n">n</span>&quot;

<span class="n">sub</span> <span class="p">{</span>
    <span class="n">db</span><span class="p">[</span>!<span class="n">data</span> <span class="n">data</span><span class="p">]</span> <span class="o">|</span> <span class="n">sub</span> <span class="p">{</span>       <span class="o">//</span> <span class="n">enumerate</span> <span class="n">all</span> <span class="n">items</span> <span class="n">in</span> <span class="n">format</span> <span class="o">~</span> <span class="n">record_t</span>
        <span class="n">db</span><span class="p">[</span>!<span class="n">data</span> <span class="n">slave</span><span class="p">].</span><span class="n">create</span><span class="p">(</span><span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">,</span> $<span class="n">key</span><span class="p">);</span>   <span class="o">//</span> <span class="n">add</span> <span class="p">{</span> <span class="n">void</span> <span class="p">=</span><span class="o">&gt;</span> $<span class="n">key</span> <span class="p">}</span> <span class="n">to</span> <span class="n">list_t</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="n">sub</span> <span class="p">{</span>
    $<span class="n">value1</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">,</span> $<span class="n">value2</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">;</span>

    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>0<span class="p">,</span> $<span class="n">value1</span><span class="p">);</span>
    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>1<span class="p">,</span> $<span class="n">value2</span><span class="p">);</span>

    $<span class="n">value1</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
    $<span class="n">value2</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Finally, we have useful configuration which take string and make key-value storage from it. We can query it, enumerate items, add or delete items.</p>
<h2>Key-value storage from string with nested data structure</h2>
<p>Querying lines is not so useful, let's do it with more complex data. For example i have lines with data, but each line have fields of certain format. To make storage from it we need to define two formats:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">local</span> <span class="n">db</span> <span class="p">=</span> 
    <span class="n">key</span>    <span class="o">~</span> <span class="n">list_t</span> <span class="p">:</span> <span class="p">{</span> <span class="p">}</span>                   <span class="o">&gt;</span>
    <span class="n">format</span> <span class="o">~</span> <span class="n">container_t</span> <span class="p">:</span> <span class="p">{</span>                          <span class="o">//</span> <span class="n">format</span> <span class="k">for</span> <span class="n">each</span> <span class="n">line</span> <span class="n">data</span>
        <span class="n">netstring_t</span> <span class="p">:</span> <span class="p">{}</span> <span class="o">&gt;</span> <span class="n">raw_t</span> <span class="p">:</span> <span class="p">{},</span>
        <span class="n">raw_t</span> <span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>                                       <span class="o">&gt;</span>
    <span class="n">format</span> <span class="o">~</span> <span class="n">record_t</span> <span class="p">:</span> &quot;<span class="o">\</span><span class="n">n</span>&quot;                <span class="o">&gt;</span>         <span class="o">//</span> <span class="n">format</span> <span class="k">for</span> <span class="n">lines</span>
    &quot;3<span class="p">:</span><span class="n">abc</span><span class="p">,</span><span class="n">hello</span> <span class="n">abc</span><span class="o">\</span><span class="n">n3</span><span class="p">:</span><span class="n">def</span><span class="p">,</span><span class="n">hello</span> <span class="n">def</span><span class="o">\</span><span class="n">n3</span><span class="p">:</span><span class="n">ghk</span><span class="p">,</span><span class="n">hello</span> <span class="n">ghk</span><span class="o">\</span><span class="n">n</span>&quot;

<span class="n">sub</span> <span class="p">{</span>
    <span class="n">db</span><span class="p">[</span>!<span class="n">data</span> <span class="n">data</span><span class="p">]</span> <span class="o">|</span> <span class="n">sub</span> <span class="p">{</span> <span class="n">db</span><span class="p">[</span>!<span class="n">data</span> <span class="n">slave</span><span class="p">].</span><span class="n">create</span><span class="p">(</span><span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">,</span> $<span class="n">key</span><span class="p">);</span> <span class="p">};</span>
<span class="p">}</span>

<span class="n">sub</span> <span class="p">{</span>
    $<span class="n">value1</span> <span class="p">=</span> <span class="n">void_t</span> <span class="p">:</span> &quot;&quot;<span class="p">,</span> $<span class="n">value2</span> <span class="p">=</span> <span class="n">void_t</span> <span class="p">:</span> &quot;&quot;<span class="p">;</span>

    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>0<span class="p">,</span> $<span class="n">value1</span><span class="p">);</span>
    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>1<span class="p">,</span> $<span class="n">value2</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">note</span> <span class="n">container_t</span> <span class="n">to</span> <span class="n">construct</span> <span class="n">output</span><span class="p">.</span>
    <span class="n">container_t</span><span class="p">:{</span> &quot;<span class="n">value1</span> <span class="p">=</span> &quot;<span class="p">,</span> $<span class="n">value1</span><span class="p">[</span>1<span class="p">],</span> &quot;<span class="o">\</span><span class="n">n</span>&quot; <span class="p">}</span> <span class="o">|</span> <span class="n">fd_t</span> <span class="p">:</span> &quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
    <span class="n">container_t</span><span class="p">:{</span> &quot;<span class="n">value2</span> <span class="p">=</span> &quot;<span class="p">,</span> $<span class="n">value2</span><span class="p">[</span>1<span class="p">],</span> &quot;<span class="o">\</span><span class="n">n</span>&quot; <span class="p">}</span> <span class="o">|</span> <span class="n">fd_t</span> <span class="p">:</span> &quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Output for this program would be:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">value1</span> <span class="p">=</span> <span class="n">hello</span> <span class="n">abc</span>
<span class="n">value2</span> <span class="p">=</span> <span class="n">hello</span> <span class="n">def</span>
</pre></div>
</td></tr></table>

<h2>Key-value from files</h2>
<p>If we need to make storage from some file we just change string definition with file definition:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">local</span> <span class="n">db</span> <span class="p">=</span> 
    <span class="n">format</span> <span class="o">~</span> <span class="n">record_t</span> <span class="p">:</span> &quot;<span class="o">\</span><span class="n">n</span>&quot;   <span class="o">&gt;</span>
    <span class="n">file_t</span> <span class="p">:</span> &quot;<span class="n">examples</span><span class="o">/</span><span class="n">article_complexdata_06</span><span class="p">.</span><span class="n">dat</span>&quot;

<span class="n">sub</span> <span class="p">{</span>
    $<span class="n">value1</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">,</span> $<span class="n">value2</span> <span class="p">=</span> <span class="n">void_t</span><span class="p">:</span>&quot;&quot;<span class="p">;</span>

    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>0<span class="p">,</span> $<span class="n">value1</span><span class="p">);</span>
    <span class="n">db</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span>7<span class="p">,</span> $<span class="n">value2</span><span class="p">);</span>

    $<span class="n">value1</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
    $<span class="n">value2</span> <span class="o">|</span> <span class="n">fd_t</span><span class="p">:</span>&quot;<span class="n">stdout</span>&quot;<span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>And "examples/article_complexdata_06.dat" is just:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span class="n">value1</span>
<span class="n">value2</span>
</pre></div>
</td></tr></table>

<h2>Customization</h2>
<p>As you can see everything fits to everything, so even in complex cases we can pick any storage (string or file or database).
Good improvements for big datasets would be nice key mapper, for example judy array, or we can use
any other kv storage to keep offsets, for example, redis or embedded leveldb. All of this is done and works very smooth.</p>
<h2>Future plans</h2>
<p>We need to make binding to other languages, not only perl. We need replications modules, key hashing and so on. With this modules we can use
any database or storage engine with whole set of features, despite of their support in target database.</p>
        
        
        
        
        <hr class="clear" />
      </div> <!-- div#content -->
      
      
      <div id="footer">
        <p>
          
            frozen —
          
          Powered by <a href="http://markdoc.org/">Markdoc</a>.
        </p>
      </div>
      
    
    
    
    <hr class="clear" />
  </body>
</html>